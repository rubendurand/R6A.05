<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Library Client</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1,
        h2 {
            margin-bottom: 1rem;
        }

        .card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            opacity: 0.9;
        }

        button.danger {
            background-color: var(--danger);
        }

        button.success {
            background-color: var(--success);
        }

        button.secondary {
            background-color: #64748b;
        }

        .hidden {
            display: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .movie-list {
            display: grid;
            gap: 1rem;
        }

        .movie-item {
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .movie-info h3 {
            margin: 0 0 0.5rem 0;
        }

        .movie-meta {
            font-size: 0.9rem;
            color: #64748b;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        #error-msg {
            color: var(--danger);
            margin-bottom: 1rem;
            display: none;
            padding: 0.5rem;
            background: #fef2f2;
            border-radius: 4px;
        }

        #success-msg {
            color: var(--success);
            margin-bottom: 1rem;
            display: none;
            padding: 0.5rem;
            background: #f0fdf4;
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="auth-section">
            <div class="card">
                <h2>Login</h2>
                <div id="login-error" class="error-json"></div>
                <form id="login-form">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" required placeholder="admin@test.com or user@test.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" required placeholder="password">
                    </div>
                    <button type="submit">Login</button>
                    <button type="button" class="secondary" onclick="toggleRegister()">Go to Register</button>
                </form>
            </div>

            <div class="card hidden" id="register-card">
                <h2>Register</h2>
                <form id="register-form">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="reg-first" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="reg-last" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="reg-email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="reg-password" required>
                    </div>
                    <div class="form-group">
                        <label>Scope</label>
                        <select id="reg-scope"
                            style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="success">Register</button>
                    <button type="button" class="secondary" onclick="toggleRegister()">Back to Login</button>
                </form>
            </div>
        </div>

        <div id="app-section" class="hidden">
            <div class="header">
                <div>
                    <h1>Movie Library</h1>
                    <p>Logged in as: <span id="user-display"></span></p>
                </div>
                <div>
                    <button onclick="logout()" class="secondary">Logout</button>
                </div>
            </div>

            <div id="error-msg"></div>
            <div id="success-msg"></div>

            <!-- Admin Controls -->
            <div id="admin-controls" class="card hidden">
                <h2>Admin Actions</h2>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="toggleAddMovie()">+ Add Movie</button>
                    <button onclick="triggerExport()" class="success">üì• Export CSV</button>
                </div>

                <div id="add-movie-form" class="hidden"
                    style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                    <h3>New Movie</h3>
                    <form onsubmit="createMovie(event)">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="m-title" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="m-desc" required>
                        </div>
                        <div class="form-group">
                            <label>Director</label>
                            <input type="text" id="m-director" required>
                        </div>
                        <div class="form-group">
                            <label>Release Date</label>
                            <input type="date" id="m-date" required>
                        </div>
                        <button type="submit">Create</button>
                        <button type="button" class="secondary" onclick="toggleAddMovie()">Cancel</button>
                    </form>
                </div>

                <div id="edit-movie-form" class="hidden"
                    style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                    <h3>Edit Movie</h3>
                    <form onsubmit="updateMovie(event)">
                        <input type="hidden" id="edit-m-id">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="edit-m-title" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="edit-m-desc" required>
                        </div>
                        <div class="form-group">
                            <label>Director</label>
                            <input type="text" id="edit-m-director" required>
                        </div>
                        <div class="form-group">
                            <label>Release Date</label>
                            <input type="date" id="edit-m-date" required>
                        </div>
                        <button type="submit">Update</button>
                        <button type="button" class="secondary" onclick="toggleEditMovie()">Cancel</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <h2>Movies</h2>
                <div id="movies-list" class="movie-list">
                    <!-- Movies will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let token = localStorage.getItem('token');
        let userEmail = localStorage.getItem('userEmail');
        let userScope = localStorage.getItem('userScope');

        // Init
        if (token) {
            showApp();
        }

        function toggleRegister() {
            document.getElementById('auth-section').querySelector('.card').classList.toggle('hidden');
            document.getElementById('register-card').classList.toggle('hidden');
        }

        function toggleAddMovie() {
            document.getElementById('add-movie-form').classList.toggle('hidden');
            document.getElementById('edit-movie-form').classList.add('hidden'); // Hide edit form if add is toggled
        }

        function showMsg(msg, type = 'success') {
            const el = document.getElementById(type === 'error' ? 'error-msg' : 'success-msg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function showApp() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('user-display').textContent = `${userEmail} (${userScope})`;

            if (userScope === 'admin') {
                document.getElementById('admin-controls').classList.remove('hidden');
            }

            loadMovies();
        }

        async function fetchAPI(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': token } : {})
            };
            const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || 'API Error');
            }
            return res.json();
        }

        // --- Auth ---

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const res = await fetchAPI('/user/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                token = res.token;
                // Decode token roughly to get scope/email since I didn't return it in login payload
                // In a real app, use a jwt-decode lib. Here we'll trust the input for display or fetch profile if exists.
                // Wait, I encoded scope in token. I can't read it easily without library or base64 decode.
                // Let's decode base64.
                const payload = JSON.parse(atob(token.split('.')[1]));
                userEmail = payload.email;
                userScope = payload.scope;

                localStorage.setItem('token', token);
                localStorage.setItem('userEmail', userEmail);
                localStorage.setItem('userScope', userScope);

                showApp();
            } catch (err) {
                alert('Login failed: ' + err.message);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const payload = {
                    firstName: document.getElementById('reg-first').value,
                    lastName: document.getElementById('reg-last').value,
                    email: document.getElementById('reg-email').value,
                    password: document.getElementById('reg-password').value,
                    scope: document.getElementById('reg-scope').value
                };
                await fetchAPI('/user/register', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                alert('Registration success! Check console/Ethereal for welcome email. You can now login.');
                toggleRegister();
            } catch (err) {
                alert('Registration failed: ' + err.message);
            }
        });

        // --- Movies ---

        async function loadMovies() {
            try {
                const movies = await fetchAPI('/movies');
                const container = document.getElementById('movies-list');
                container.innerHTML = movies.map(movie => {
                    const releaseDateISO = new Date(movie.releaseDate).toISOString().split('T')[0];
                    // Escape quotes for safely passing as arguments (very basic)
                    const safeTitle = movie.title.replace(/'/g, "\\'");
                    const safeDesc = movie.description.replace(/'/g, "\\'");
                    const safeDirector = movie.director.replace(/'/g, "\\'");

                    return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <h3>${movie.title}</h3>
                            <p>${movie.description}</p>
                            <div class="movie-meta">
                                Director: ${movie.director} | Released: ${new Date(movie.releaseDate).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="actions">
                            ${userScope === 'user' ? `
                                <button class="secondary" onclick="addFavorite(${movie.id})">‚ù§Ô∏è Fav</button>
                                <button class="danger" onclick="removeFavorite(${movie.id})">üíî Unfav</button>
                            ` : ''}
                            ${userScope === 'admin' ? `
                                <button class="secondary" onclick="prepareEdit(${movie.id}, '${safeTitle}', '${safeDesc}', '${safeDirector}', '${releaseDateISO}')">Edit</button>
                                <button class="danger" onclick="deleteMovie(${movie.id})">Delete</button>
                            ` : ''}
                        </div>
                    </div>
                `}).join('');
            } catch (err) {
                console.error('Failed to load movies:', err);
            }
        }

        async function createMovie(e) {
            e.preventDefault();
            try {
                const payload = {
                    title: document.getElementById('m-title').value,
                    description: document.getElementById('m-desc').value,
                    director: document.getElementById('m-director').value,
                    releaseDate: document.getElementById('m-date').value
                };
                await fetchAPI('/movies', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                showMsg('Movie created! Welcome notifications might have been logged.');
                document.getElementById('add-movie-form').classList.add('hidden');
                e.target.reset();
                loadMovies();
            } catch (err) {
                showMsg(err.message, 'error');
            }
        }

        function toggleEditMovie() {
            document.getElementById('edit-movie-form').classList.toggle('hidden');
            document.getElementById('add-movie-form').classList.add('hidden'); // Hide add form if edit is toggled
        }

        function prepareEdit(id, title, desc, director, date) {
            document.getElementById('edit-movie-form').classList.remove('hidden');
            document.getElementById('add-movie-form').classList.add('hidden');
            document.getElementById('edit-m-id').value = id;
            document.getElementById('edit-m-title').value = title;
            document.getElementById('edit-m-desc').value = desc;
            document.getElementById('edit-m-director').value = director;
            document.getElementById('edit-m-date').value = date;
        }

        async function updateMovie(e) {
            e.preventDefault();
            const id = document.getElementById('edit-m-id').value;
            try {
                const payload = {
                    title: document.getElementById('edit-m-title').value,
                    description: document.getElementById('edit-m-desc').value,
                    director: document.getElementById('edit-m-director').value,
                    releaseDate: document.getElementById('edit-m-date').value
                };
                await fetchAPI(`/movies/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });
                showMsg('Movie updated! Check console for update notifications.');
                document.getElementById('edit-movie-form').classList.add('hidden');
                loadMovies();
            } catch (err) {
                showMsg(err.message, 'error');
            }
        }

        async function deleteMovie(id) {
            if (!confirm('Are you sure?')) return;
            try {
                await fetch(`${API_URL}/movies/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': token }
                });
                loadMovies();
                showMsg('Movie deleted');
            } catch (err) {
                showMsg(err.message, 'error');
            }
        }

        async function triggerExport() {
            try {
                const res = await fetchAPI('/movies/export', { method: 'POST' });
                showMsg(res.message);
            } catch (err) {
                showMsg(err.message, 'error');
            }
        }

        // --- Favorites ---

        async function addFavorite(id) {
            try {
                const res = await fetchAPI(`/movies/${id}/favorite`, { method: 'POST' });
                showMsg(res.message);
            } catch (err) {
                showMsg(err.message, 'error');
            }
        }

        async function removeFavorite(id) {
            try {
                const res = await fetchAPI(`/movies/${id}/favorite`, { method: 'DELETE' });
                showMsg(res.message);
            } catch (err) {
                showMsg(err.message, 'error');
            }
        }

    </script>

</body>

</html>